#!/bin/sh
# Pinentry wrapper that uses 1Password CLI to retrieve GPG passphrase
# Uses personal 1Password account for GPG passphrase

LOG=${LOG:-/dev/null}
COMMAND="op read op://Personal/d4xe37k5vnkkjmx5hk3vxiinn4/passphrase --account my.1password.com"

echo "OK"

while read cmd rest; do
    echo "cmd=$cmd rest=$rest" >&2
    echo "cmd=$cmd rest=$rest" >> $LOG

    case "$cmd" in
        \#*)
            echo "OK"
            ;;
        GETPIN)
            PASSPHRASE=${PASSPHRASE-`$COMMAND`}
            echo "D ${PASSPHRASE}"
            echo "OK"
            ;;
        BYE)
            echo "OK"
            exit 0
            ;;
        *)
            echo "OK"
            ;;
    esac
done
