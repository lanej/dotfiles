#!/usr/bin/env bash
# Claude Code status line with git status information (like starship)

set -euo pipefail

# Read JSON input from stdin
input=$(cat)
cwd=$(echo "$input" | jq -r '.workspace.current_dir')

# Change to the working directory
cd "$cwd" 2>/dev/null || true

# Base info: user@host directory
user=$(whoami)
host=$(hostname -s)
dir=$(basename "$cwd")

# Start building the status line
printf '\033[36m%s@%s \033[32m%s' "$user" "$host" "$dir"

# Git information (if in a git repo)
if git rev-parse --git-dir >/dev/null 2>&1; then
  # Get current branch
  branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")

  if [ -n "$branch" ]; then
    # Branch name in blue
    printf ' \033[34m(%s' "$branch"

    # Check for upstream and ahead/behind counts
    upstream=$(git rev-parse --abbrev-ref @{upstream} 2>/dev/null || echo "")
    if [ -n "$upstream" ]; then
      ahead=$(git rev-list --count @{upstream}..HEAD 2>/dev/null || echo "0")
      behind=$(git rev-list --count HEAD..@{upstream} 2>/dev/null || echo "0")

      if [ "$ahead" -gt 0 ] && [ "$behind" -gt 0 ]; then
        printf ' \033[36m⇕⇡%s⇣%s\033[34m' "$ahead" "$behind"
      elif [ "$ahead" -gt 0 ]; then
        printf ' \033[36m⇡%s\033[34m' "$ahead"
      elif [ "$behind" -gt 0 ]; then
        printf ' \033[33m⇣%s\033[34m' "$behind"
      fi
    fi

    # Count modified/staged files
    modified=$(git diff --name-only 2>/dev/null | wc -l | tr -d ' ')
    staged=$(git diff --cached --name-only 2>/dev/null | wc -l | tr -d ' ')
    untracked=$(git ls-files --others --exclude-standard 2>/dev/null | wc -l | tr -d ' ')

    if [ "$modified" -gt 0 ] || [ "$staged" -gt 0 ] || [ "$untracked" -gt 0 ]; then
      printf ' '
      [ "$staged" -gt 0 ] && printf '\033[32m+%s\033[34m' "$staged"        # Green for staged
      [ "$modified" -gt 0 ] && printf '\033[33m~%s\033[34m' "$modified"    # Yellow for modified
      [ "$untracked" -gt 0 ] && printf '\033[31m?%s\033[34m' "$untracked"  # Red for untracked
    fi

    printf ')'
  fi
fi

# Reset colors
printf '\033[0m'
