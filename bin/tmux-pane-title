#!/bin/bash
# Get pane title with current directory and git branch

pane_pid="$1"
fallback_path="$2"

# Get the working directory of the pane's process
if [[ "$OSTYPE" == "darwin"* ]]; then
  # macOS - use lsof to get current working directory
  current_path=$(lsof -a -d cwd -p "$pane_pid" 2>/dev/null | awk 'NR>1 {print $NF}' | head -1)
else
  # Linux - use /proc
  current_path=$(readlink -f "/proc/$pane_pid/cwd" 2>/dev/null)
fi

# Fallback to tmux's pane_current_path if lsof/proc fails
if [ -z "$current_path" ] || [ ! -d "$current_path" ]; then
  current_path="$fallback_path"
fi

# Handle empty current_path
if [ -z "$current_path" ]; then
  echo "unknown"
  exit 0
fi

# Get the directory name (not full path)
dir_name=$(basename "$current_path")

# Check if we're in a git repository and get the branch
if [ -d "$current_path" ] && git -C "$current_path" rev-parse --git-dir >/dev/null 2>&1; then
  branch=$(git -C "$current_path" rev-parse --abbrev-ref HEAD 2>/dev/null)
  if [ -n "$branch" ]; then
    echo "$dir_name [$branch]"
  else
    echo "$dir_name"
  fi
else
  echo "$dir_name"
fi
