#!/bin/bash

# Setup script for encrypted Git repositories with git-remote-gcrypt
# Generated by secure-git installer

set -e

# Configuration from environment variables (set in ~/.env)
# ENCRYPTED_REPO_BASE: Base directory for encrypted repositories
# ENCRYPTED_REPO_GPG_KEY: GPG key ID for encryption/signing
GDRIVE_BASE="${ENCRYPTED_REPO_BASE:-$HOME/encrypted-repos}"
GPG_KEY="${ENCRYPTED_REPO_GPG_KEY}"

# Validate configuration
if [ -z "$GPG_KEY" ]; then
    echo -e "\033[0;31mError: ENCRYPTED_REPO_GPG_KEY not set in ~/.env\033[0m"
    echo "Add this to ~/.env:"
    echo "  export ENCRYPTED_REPO_GPG_KEY=\"your-gpg-key-id\""
    echo ""
    echo "Find your GPG key with: gpg --list-secret-keys --keyid-format=long"
    exit 1
fi

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get repo name from argument or current directory name
if [ -n "$1" ]; then
    REPO_NAME="$1"
else
    REPO_NAME=$(basename "$PWD")
fi

echo -e "${BLUE}Setting up encrypted repository: ${REPO_NAME}${NC}"

# Check if git is initialized
if [ ! -d ".git" ]; then
    echo -e "${YELLOW}No git repository found. Initializing...${NC}"
    git init
    echo -e "${GREEN}✓ Git repository initialized${NC}"
else
    echo -e "${GREEN}✓ Git repository already initialized${NC}"
fi

# Create encrypted repo directory in Google Drive
ENCRYPTED_PATH="${GDRIVE_BASE}/${REPO_NAME}"
mkdir -p "$GDRIVE_BASE"

if [ ! -d "$ENCRYPTED_PATH" ]; then
    mkdir -p "$ENCRYPTED_PATH"
    echo -e "${GREEN}✓ Created encrypted storage directory${NC}"
else
    echo -e "${YELLOW}⚠ Encrypted storage directory already exists${NC}"
fi

# Check if remote already exists
if git remote | grep -q "^encrypted$"; then
    echo -e "${YELLOW}⚠ Remote 'encrypted' already exists. Removing...${NC}"
    git remote remove encrypted
fi

# Add encrypted remote
git remote add encrypted "gcrypt::${ENCRYPTED_PATH}"
echo -e "${GREEN}✓ Added encrypted remote${NC}"

# Configure GPG key for encryption
git config remote.encrypted.gcrypt-participants "$GPG_KEY"
git config remote.encrypted.gcrypt-signingkey "$GPG_KEY"
echo -e "${GREEN}✓ Configured GPG encryption${NC}"

# Display summary
echo ""
echo -e "${BLUE}════════════════════════════════════════════════${NC}"
echo -e "${GREEN}Setup complete!${NC}"
echo -e "${BLUE}════════════════════════════════════════════════${NC}"
echo ""
echo "Repository name: ${REPO_NAME}"
echo "Encrypted storage: ${ENCRYPTED_PATH}"
echo "GPG key: ${GPG_KEY}"
echo ""
echo "Usage:"
echo "  git add ."
echo "  git commit -m \"Your message\""
echo "  git push encrypted main"
echo ""
echo -e "${YELLOW}Note: Google Drive for Desktop will automatically sync encrypted files to the cloud${NC}"
